<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" user-scalable="no">
  <title>Level-Four</title>
  <link rel="stylesheet" href="./assets/index.css">
  <script src="./assets/utils.js"></script>
</head>
<body>
  <div class="loading">数据加载中...</div>
  <header class="header" style="display: none;">
    <div class="statistic-wrap" >
      <div class="statistic-correct">
        <span>正确*</span>
        <span class="count-correct">0</span>
      </div>
      <div class="statistic-mistake">
        <span>错误*</span>
        <span class="count-mistake">0</span>
      </div>
      <div class="statistic-answer">
        <span>总答题*</span>
        <span class="count-answer">0</span>
      </div>
      <div class="statistic-question">
        <span>总题数*</span>
        <span class="count-question">0</span>
      </div>
    </div>
  </header>
  <div class="tag-wrap" style="display: none">
  </div>
  <div class="index-wrap" style="display: none"></div>
  <div class="testing-wrap" style="display: none"></div>
  <div class="switch-wrap" style="display: none">
    <div class="switch-item last-btn">上一题</div>
    <div class="switch-item next-btn">下一题</div>
  </div>
  <div class="operation">
    <div class="mode"></div>
    <div class="reset">重置记录</div>
  </div>

  <script>  
    _ds = {
      version: '2024.9.18.1',
      mode: void 0,
      questionBanks: {},
      statistic: {
        correct: 0,
        mistake: 0,
        answer: 0,
        question: 0
      },
      lastQuestionIdx: void 0,
      correctColor_index: 'rgb(39, 174, 96, .5)',
      mistakeColor_index: 'rgb(255, 94, 87, .5)',
      correctColor_option: 'rgb(39, 174, 96, .3)',
      mistakeColor_option: 'rgb(255, 94, 87, .3)',
    }

    let _testing = []
    Object.defineProperty(_ds, 'testing', {
      get() {
        return _testing
      },
      set(newVal) {
        _testing = newVal

        generateIndexItems(newVal)
        
        setTimeout(() => {
          const indexItems = $$('.index-item')
          if(_ds.mode == 1) {
            const nextQuestion = indexItems.find(item => item.selectIdx === void 0)
            if(nextQuestion) {
              nextQuestion.click()
            } else {
              indexItems.at(-1)?.click()
            }
          } else {
            let idx_range = []
            _ds.testing.forEach((item, idx) => {
              if (item.selectIdx == void 0) idx_range.push(idx)
            })
            if (idx_range.length) {
              const random_idx = idx_range[randomNum(0, idx_range.length - 1)]
              _ds.selIdx = random_idx
            } else {
              _ds.selIdx = indexItems.length-1
            }
          }

          $$('.index-item')[_ds.selIdx].scrollIntoView({ behavior: "smooth", block: "center" })
        })
        
        
        statistic()
      }
    })
    let _selIdx = 0
    Object.defineProperty(_ds, 'selIdx', {
      get() {
        return _selIdx
      },
      set(newVal) {
        if(newVal < 0 || newVal > _ds.testing.length-1) return
        _selIdx = newVal

        generateQuestion(_selIdx+1)
      }
    })
    let _selTag = localStorage.getItem('selTag') ?? ''
    Object.defineProperty(_ds, 'selTag', {
      get() {
        return _selTag
      },
      set(newVal) {
          if(newVal !== '标记') {
            _ds.testing = _ds.questionBanks[newVal]
            _selTag = newVal
            localStorage.setItem('selTag', newVal)
            updateStyle()
            _ds.lastQuestionIdx = void 0
          } else {
            const collection = []
            for(let k in _ds.questionBanks) {
              _ds.questionBanks[k].forEach(item => {
                if(item.isCollect) collection.push(item)
              })
            }
            if(!collection.length) {
              alert('暂无被标记的题目，可尝试点击题目序号将其转为被标记状态。')
              if(_ds.selTag == '标记') _ds.selTag = '四级'
              return
            }
            _ds.testing = collection
            _selTag = newVal
            localStorage.setItem('selTag', newVal)
            updateStyle()
            _ds.lastQuestionIdx = void 0
          }

          function updateStyle() {
            $$('.tag').forEach(tag => {
              const isCurrent = tag.bankName == newVal
              setStyle(tag, {
                height: isCurrent ? '25px' : '20px',
                color: isCurrent ? '#444' : '#888',
                lineHeight: isCurrent ? '25px' : '20px',
                fontSize: isCurrent ? '13.5px' : '13px',
              })
            })
          }
      }
    })

    const mode = localStorage.getItem('mode')
    if(mode) {
      _ds.mode = parseInt(mode)
      $('.mode').innerText = mode == 1 ? '顺序切题' : '随机切题'
    } else {
      _ds.mode = 1
      $('.mode').innerText = '顺序切题' 
      localStorage.setItem('mode', _ds.mode)
    }
    $('.mode').onclick = function() {
      this.innerText = _ds.mode == 1 ? '随机切题' : '顺序切题'
      _ds.mode = _ds.mode == 1 ? 2 : 1
      localStorage.setItem('mode', _ds.mode)
    }

    dataLoad().then(res => {
      $('.loading').remove()

      setStyle(['header', '.tag-wrap', '.index-wrap', '.testing-wrap','.switch-wrap'].map(sel => $(sel)), {
        display: null
      })

      tagList = ['四级', '五级', '标记']
      tagList.forEach(tagName => {
        const tag = createEl('div', {
          className: 'tag',
          bankName: tagName,
          innerText: tagName,
          onclick: function() {
            _ds.selTag = this.bankName
          }
        })
        $('.tag-wrap').append(tag)
      })

      _ds.selTag = localStorage.getItem('selTag') ?? '四级'

      $('.last-btn').onclick = function() {
        if(_ds.lastQuestionIdx !== void 0) {
          _ds.selIdx = _ds.lastQuestionIdx
          _ds.lastQuestionIdx = void 0
        } else {
          _ds.selIdx--
        }
      }

      $('.next-btn').onclick = function() {
        _ds.selIdx++
      }

      $('.reset').onclick = function() {
        if(!confirm(`是否重置当前【${_ds.selTag}】中的作业记录？`)) return
        _ds.testing.forEach(item => item.selectIdx = void 0)
        _ds.selTag = _ds.selTag
        localStorage.setItem('local_record', JSON.stringify(_ds.questionBanks))
      }

    })

    function generateIndexItems(questionBank) {
      $('.index-wrap').innerHTML = ''

      for(let sn = 1; sn <= questionBank.length; ++sn) {
        const curQuestion = questionBank[sn-1]
        const correctIdx = curQuestion.correctIdx
        const selectIdx = curQuestion.selectIdx

        const index = createEl('div', {
          className: 'index-item',
          innerText: sn,
          questionId: questionBank[sn-1].id,
          selectIdx,
          correctIdx: correctIdx,
          onclick: function() {
            _ds.selIdx = sn-1
            this.selectIdx = questionBank[sn-1].selectIdx
          },
          style: {
            background: selectIdx === void 0 ? null : 
            curQuestion.selectIdx === correctIdx ? _ds.correctColor_index : _ds.mistakeColor_index
          }
        })
        $('.index-wrap').append(index)
      }
    }

    function dataLoad() {
      const fetchMap = [['四级', './testing-data/level-four.json'], ['五级', './testing-data/level-five.json']]
      
      return Promise.all(fetchMap.map(([name, url]) => fetch(url).then(res => res.json())))
      .then(allRes => {
        const questionBanks = {}
        allRes.map((res, idx) => {
          let bank = questionBanks[fetchMap[idx][0]] = []

          res.map(({data}) => {
            data.isCollect = false

            data.optionList.some((option, idx) => {
              const isCorrect = option.id == data.answer.optionIdSet
              if(isCorrect) data.correctIdx = idx
              option.isCorrect = isCorrect
            })
            bank.push(data)
          })
        })

        const version = localStorage.getItem('version')
        if(version === _ds.version) {
          const local_record = JSON.parse(localStorage.getItem('local_record'))
          if(local_record) _ds.questionBanks = local_record
        } else {
          _ds.questionBanks = questionBanks
          localStorage.setItem('local_record', JSON.stringify(_ds.questionBanks))
          localStorage.setItem('version', _ds.version)
        }


      })
      


      // //尝试使用缓存并校验
      // try {
      //   const record_local = JSON.parse(localStorage.getItem('record'))
      //   if(Array.isArray(record_local) && record.length == record_local.length) {
      //     const isSame = record.every((item, idx) => {
      //       for(let k in item) {
      //         const compareKeys = ['id', 'correctIdx']
      //         for(let i = 0; i < compareKeys.length; i++) {
      //           if(compareKeys.includes(k) && record[idx][k] !== record_local[idx][k]) {
      //             return false
      //           }
      //         }
      //       }
      //       return true
      //     })
      //     if(isSame) {
      //       _ds.record = confirm('是否使用历史记录') ? record_local : record
      //     } else {
      //       throw('本地数据异常')
      //     }
      //   } else if(record_local === null) {
      //     _ds.record = record
      //     localStorage.setItem('record', JSON.stringify(_ds.record))
      //   } else {
      //     _ds.record = record
      //     throw('本地数据异常')
      //   }
      // } catch(e) {
      //   _ds.record = record
      //   localStorage.setItem('record', JSON.stringify(_ds.record))

      //   alert('本地数据异常，现已对数据进行重置')
      // }

      // statistic()

    }

    function generateQuestion(sn) {
      if(sn <= 0 || sn > _ds.testing.length) return

      const testingWrap = $('.testing-wrap')

      const idx = sn-1
      const curQuestion = _ds.testing[idx]
      const { correctIdx, selectIdx, content, optionList} = curQuestion
      const {correctColor_option: correctColor, mistakeColor_option: mistakeColor} = _ds
      const indexItems = $$('.index-item')
      const index_item_map = indexItems[idx]
      index_item_map.scrollIntoView({ behavior: "smooth", block: "center" });

      $('.testing-wrap').innerHTML = ''

      const questionWrap = createEl('div', {
        className: 'question-wrap',
      })

      const questionIndex = createEl('span', {
        innerText: sn+'.',
        className: 'question-index',
        onclick: function() {
          const isCollect = curQuestion.isCollect
          this.style.backgroundPosition = isCollect ? '0px' : '40px'
          curQuestion.isCollect = !isCollect
          localStorage.setItem('local_record', JSON.stringify(_ds.questionBanks))
        },
        style: {
          backgroundPosition: curQuestion.isCollect ? '40px' : '0px'
        }
      })

      const questionInfo = createEl('span', {
        innerText: content,
        className: 'question-info',
      })

      questionWrap.append(questionIndex, questionInfo)
      testingWrap.append(questionWrap)

      indexItems.forEach((item, idx) => {
        const isCurrent = idx == sn-1
        setStyle(item, {
          boxShadow: isCurrent ? '0px 0px 8px rgba(0, 0, 0, .12)' : null,
          textShadow: isCurrent ? '0px 0px 8px rgb(255, 255, 255)' : null,
          width: isCurrent ? '43px' : '40px',
          height: isCurrent ? '37px' : '35px',
          lineHeight: isCurrent ? '37px' : '35px',
        })
      })
      
      optionList.forEach(({content, isCorrect}, idx) => {
        const color_tip = (selectIdx === void 0 || idx !== selectIdx) ? null : //该题目还没做 或 该选项未选中 时没有颜色
            idx == correctIdx ? correctColor : mistakeColor
        const option = createEl('div', {
          innerText: content,
          className: 'option',
          isCorrect,
          style: {
            background: color_tip,
            borderLeft: `8px solid ${color_tip}`,
          },
          onclick: function(e) {
            const _this = this
            $$('.option').forEach((item, idx) => {
              if(item == _this) {
                item.style.background = item.isCorrect ? correctColor : mistakeColor
                item.style.borderLeft = `8px solid ${item.isCorrect ? correctColor : mistakeColor}`

                index_item_map.style.background = item.isCorrect ? _ds.correctColor_index : _ds.mistakeColor_index
                
                _ds.testing[sn-1].selectIdx = idx

                if(_this.isCorrect) {
                  setTimeout(()=> {
                    switchNextQuestion(sn)
                  }, 400)
                }
              } else {
                item.style.background = null
                item.style.borderLeft = '8px solid transparent'
              }

              localStorage.setItem('local_record', JSON.stringify(_ds.questionBanks))

              statistic()
            })
          }
        })
        
        testingWrap.append(option)
      })
    }
    
    function switchNextQuestion(sn) {
      if (_ds.mode == 1) {
        const next_idx = _ds.testing.findIndex((item, idx) => idx > sn - 1 && item.selectIdx === void 0)
        _ds.selIdx = next_idx
        _ds.lastQuestionIdx = random_idx

      } else {
        let idx_range = []
        _ds.testing.forEach((item, idx) => {
          if (item.selectIdx == void 0) idx_range.push(idx)
        })
        if (idx_range.length) {
          const random_idx = idx_range[randomNum(0, idx_range.length - 1)]
          _ds.lastQuestionIdx = _ds.selIdx
          _ds.selIdx = random_idx
        }
      }
    }

    //取得[n,m]范围随机数
    function randomNum(minNum, maxNum) {
      switch (arguments.length) {
        case 1:
          return parseInt(Math.random() * minNum + 1, 10);
          break;
        case 2:
          return parseInt(Math.random() * (maxNum - minNum + 1) + minNum, 10);
          break;
        default:
          return 0;
          break;
      }
    }

    function statistic() {
      const statistic = {
        correct: 0,
        mistake: 0,
        answer: 0,
        question: 0
      }

      _ds.testing.forEach((item, idx) => {
        if(item.selectIdx !== void 0) {
          ++statistic.answer
          ++statistic[item.correctIdx === item.selectIdx ? 'correct' : 'mistake']
        }
        ++statistic.question
      })

      const classNameDic = {
        correct: 'count-correct',
        mistake: 'count-mistake',
        answer: 'count-answer',
        question: 'count-question',
      }
      for(let k in classNameDic) {
        $('.'+classNameDic[k]).innerText = statistic[k]
      }

      _ds.statistic = statistic
    }

  </script>
</body>
</html>
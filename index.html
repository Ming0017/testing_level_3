<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" user-scalable="no">
  <title>Level-Four</title>
  <link rel="stylesheet" href="./assets/index.css">
</head>
<body>
  <div class="loading">数据加载中...</div>
  <header class="header">
    <div class="statistic-wrap">
      <div>正确*0</div>
      <div>错误*0</div>
      <div>总回答*0</div>
      <div>总题数*0</div>
    </div>
    <div class="operation-wrap">
      <div>自动下一题</div>
    </div>
    <div class=""></div>
  </header>
  <div class="index-wrap"></div>
  <div class="testing-wrap"></div>
  <div class="switch-wrap">
    <div class="switch-item last-btn">上一题</div>
    <div class="switch-item next-btn">下一题</div>
  </div>
  <script>  
    window.$ = Document.prototype.$ = Element.prototype.$ = $
    window.$$ = Document.prototype.$$ = Element.prototype.$$ = $$

    fetch('./testing-data/level-five.json')
    .then(res => res.json())
    .then(async (res) => {
      const level_five_data = res
      const level_four_data = await fetch('./testing-data/level-four.json').then(res => res.json())
      const testings = [...level_four_data, ...level_five_data].map(({data}) => {
        data.optionList.some((option) => {
          option.isCorrect = option.id == data.answer.optionIdSet
        })
        return data
      })

      $('.loading').remove()

      console.log(testings)

      const testingWarp = $('.testing-wrap')
      const indexWrap = $('.index-wrap')

      for(let sn = 1; sn <= testings.length; ++sn) {
        const index = createEl('div', {
          className: 'index-item',
          innerText: sn,
          correctIdx: testings[sn-1].optionList.findIndex(item => item.isCorrect),
          onclick: function() {
            generateTesting(sn)
          }
        })
        indexWrap.append(index)
      }

      function generateTesting(sn) {
        const indexItems = $$('.index-item')
        if(sn < 0 || sn > indexItems.length) return alert(1)

        const idx = sn-1
        const correctColor = 'rgb(39, 174, 96, .5)'
        const mistakeColor = 'rgb(255, 94, 87, .5)'
        const {content, optionList} = testings[idx]
        const index_item_map = indexItems[idx]
        console.log(index_item_map)

        $('.testing-wrap').innerHTML = ''

        const questionWrap = createEl('div', {
          className: 'question-wrap',
        })

        const questionIndex = createEl('span', {
          innerText: sn+'.',
          className: 'question-index',
        })

        const questionInfo = createEl('span', {
          innerText: content,
          className: 'question-info',
        })

        questionWrap.append(questionIndex, questionInfo)
        testingWarp.append(questionWrap)
        
        optionList.forEach(({content, isCorrect}, idx) => {
          const option = createEl('div', {
            innerText: content,
            className: 'option',
            isCorrect,
            style: {
              background: (index_item_map.select === void 0 || idx !== index_item_map.select) ? null : //该题目还没做 或 该选项未选中 时没有颜色
              idx == index_item_map.correctIdx ? correctColor : mistakeColor
            },
            onclick: function(e) {
              const _this = this
              $$('.option').forEach((item, idx) => {
                if(item == _this) {
                  index_item_map.select = idx
                  item.style.background = item.isCorrect ? correctColor : mistakeColor
                  index_item_map.style.background = item.isCorrect ? correctColor : mistakeColor
                } else {
                  item.style.background = null
                }

                setTimeout(()=> {
                  generateTesting(sn+1)
                  // $$('.index-item')[idx+1].scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
                }, 400)
              })
            }
          })
          
          testingWarp.append(option)
        })
      }
      
    })


    function $(selector) {
      const _this = Element.prototype.isPrototypeOf(this) ? this : document
      const sel = String(selector).trim();

      const id = /^#([^ +>~\[:]*)$/.exec(sel)?.[1]
      return (id && _this === document) ? _this.getElementById(id) : _this.querySelector(sel)
    }

    function $$(selector) {
      const _this = Element.prototype.isPrototypeOf(this) ? this : document
      return Array.from(_this.querySelectorAll(selector))
    }

    function setStyle() {
      [[Map, () => {
        const styleMap = arguments[0]
        for (const [el, styleObj] of styleMap) {
          !Array.isArray(el) ? setStyleObj(el, styleObj) : el.forEach((el) => setStyleObj(el, styleObj))
        }
      }], [Element, () => {
        const [el, styleObj] = arguments
        setStyleObj(el, styleObj)
      }], [Array, () => {
        const [els, styleObj] = arguments
        els.forEach((el) => setStyleObj(el, styleObj))
      }]].some(([O, fn]) => O.prototype.isPrototypeOf(arguments[0]) ? (fn(), true) : false)

      function setStyleObj(el, styleObj) {
        for (const attr in styleObj) {
          if (el.style[attr] !== undefined) {
            el.style[attr] = styleObj[attr]
          } else {
            //将key转为标准css属性名
            const formatAttr = attr.replace(/[A-Z]/, match => `-${match.toLowerCase()}`)
            console.error(el, `的 ${formatAttr} CSS属性设置失败!`)
          }
        }
      }
    }

    function createEl(elName, options) {
      const el = document.createElement(elName)
      for(let opt in options) {
        if(opt !== 'style') {
          el[opt] = options[opt]
        } else {
          let styles = options[opt]
          setStyle(el, styles)
        }
      }
      return el
    }
  </script>
</body>
</html>